#!/usr/bin/env bash
# https://github.com/kevinhwang91/dotfiles/blob/156c2e258c17677081b412675cef45b07a597a7c/script/shell/osc52send
# https://medium.com/free-code-camp/tmux-in-practice-integration-with-system-clipboard-bcd72c62ff7b
# https://sunaku.github.io/tmux-yank-osc52.html

set -e
buf=$(cat "$@")
buflen=$( printf %s "$buf" | wc -c )
maxlen=74994

if [ "$buflen" -gt "$maxlen" ]; then
  printf "input is %d bytes too long" "$(( buflen - maxlen ))" >&2
fi

esc="\033]52;c;$( printf %s "$buf" | head -c $maxlen | base64 | tr -d '\r\n' )\a"
if [[ -n $SSH_TTY ]]; then
  otty=$SSH_TTY
elif [[ -n $TMUX ]]; then
  esc="\033Ptmux;\033$esc\033\\"
  otty=$(tmux list-panes -F "#{pane_active} #{pane_tty}" | awk '$1=="1" { print $2 }')
else
  otty=$TTY
  if [[ -z $otty ]]; then
    otty="/dev/$(ps -p $PPID -o tty=)"
  fi
  if [[ -z $otty ]]; then
    echo -n "$buf"
    exit 2
  fi
fi

printf "$esc" >$otty
