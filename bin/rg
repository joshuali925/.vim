#!/usr/bin/env bash
if [ ! -x $HOME/.local/bin/rg ]; then
  mkdir -p $HOME/.local/bin
  if [ $(uname -s) == 'Darwin' ]; then
    if [ $(uname -m) == 'arm64' ]; then
      url=$(curl -s https://api.github.com/repos/microsoft/ripgrep-prebuilt/releases/latest | grep "browser_download_url.*aarch64-apple-darwin" | cut -d '"' -f 4)
      extract_flags=rg
    else
      url=$(curl -s https://api.github.com/repos/BurntSushi/ripgrep/releases/latest | grep "browser_download_url.*x86_64-apple-darwin" | cut -d '"' -f 4)
      extract_flags='--strip-components=1 */rg'
    fi
  else
    if [ $(uname -m) == 'x86_64' ] || [ $(uname -m) == 'amd64' ]; then
      url=$(curl -s https://api.github.com/repos/BurntSushi/ripgrep/releases/latest | grep "browser_download_url.*x86_64-unknown-linux" | cut -d '"' -f 4)
      extract_flags='--strip-components=1 --wildcards ripgrep*/rg'
    else
      url=$(curl -s https://api.github.com/repos/microsoft/ripgrep-prebuilt/releases/latest | grep "browser_download_url.*aarch64-unknown-linux" | cut -d '"' -f 4)
      extract_flags=rg
    fi
  fi
  echo "Installing ripgrep from $url" >&2
  curl -sL -o- $url | tar xz -C $HOME/.local/bin $(echo "$extract_flags")
fi
$HOME/.local/bin/rg "$@"
