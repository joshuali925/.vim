#!/usr/bin/env bash
set -e

ls() {
  aws ec2 describe-instances --query "Reservations[*].Instances[*][Tags[?Key=='Name'].Value[] | [0], to_string(NetworkInterfaces[0].Association.PublicDnsName || ''), State.Name, InstanceType, InstanceId] | sort_by([], &[2])" --output table
}

change_state() {
  local desired_state=$1 ids
  ids=$(aws ec2 describe-instances --filter 'Name=tag-key,Values=Name' 'Name=tag-value,Values=*' \
    "Name=instance-state-name,Values=$([[ $desired_state = start ]] && echo stopped || echo running)" \
    --query "Reservations[*].Instances[*][Tags[?Key=='Name'].Value[] | [0],InstanceId]" --output text |
    if [[ -n $2 ]]; then grep "^$2\s"; else fzf --multi; fi | awk '{print $2}') && aws ec2 "$desired_state-instances" --instance-ids $(echo $ids)
}

create() {
  local tag instance_type="m8i.large" volume_size=30 security_group user_data run_output instance_id host
  local usage="Usage: ${0##*/} create <tag> [-i|--instance-type <type> (default $instance_type)] [-v|--volume-size <gigabytes> (default $volume_size)]"
  usage() { echo "$usage" >&2; return 1; }
  while [[ $# -ne 0 ]]; do
    case $1 in
      -i|--instance-type) instance_type="$2"; shift 2 ;;
      -v|--volume-size) volume_size="$2"; shift 2 ;;
      -*) usage ;;
      *) [[ -n $tag ]] && usage; tag="$1"; shift ;;
    esac
  done
  if [[ -z $tag ]]; then usage; fi
  security_group=$(aws ec2 describe-security-groups --group-names 'ec2-cli-security-group' --query 'SecurityGroups[0].GroupId' --output text 2> /dev/null) || true
  if [[ -z $security_group ]]; then
    security_group=$(aws ec2 create-security-group --group-name 'ec2-cli-security-group' --description 'created using aws cli for ec2' --vpc-id "$(aws ec2 describe-vpcs --filters 'Name=isDefault,Values=true' --query 'Vpcs[0].VpcId' --output text)" --query 'GroupId' --output text)
    aws ec2 authorize-security-group-ingress --group-id "$security_group" --ip-permissions '{"IpProtocol":"tcp","FromPort":22,"ToPort":22,"IpRanges":[{"CidrIp":"0.0.0.0/0"}]}' '{"IpProtocol":"tcp","FromPort":443,"ToPort":443,"IpRanges":[{"CidrIp":"0.0.0.0/0"}]}' '{"IpProtocol":"tcp","FromPort":80,"ToPort":80,"IpRanges":[{"CidrIp":"0.0.0.0/0"}]}' '{"IpProtocol":"tcp","FromPort":29128,"ToPort":29128,"IpRanges":[{"CidrIp":"0.0.0.0/0"}]}' > /dev/null
  fi
  user_data=$(printf '#cloud-config\nssh_authorized_keys:\n  - %s' "$(ssh-keygen -y -f ~/.ssh/id_ed25519)")
  user_data+=$'\nruncmd:\n  - su - ubuntu -c \'curl -fsSL https://raw.githubusercontent.com/joshuali925/.vim/HEAD/install.sh | bash\''
  run_output=$(aws ec2 run-instances --tag-specifications '{"ResourceType":"instance","Tags":[{"Key":"Name","Value":"'"$tag"'"}]}' \
    --instance-type "$instance_type" --count '1' --user-data "$user_data" \
    --image-id "resolve:ssm:/aws/service/canonical/ubuntu/server/24.04/stable/current/$([[ "${instance_type%.*}" =~ g ]] && echo "arm64" || echo "amd64")/hvm/ebs-gp3/ami-id" \
    --block-device-mappings '{"DeviceName":"/dev/sda1","Ebs":{"Encrypted":false,"DeleteOnTermination":true,"Iops":3000,"VolumeSize":'"$volume_size"',"VolumeType":"gp3","Throughput":125}}' \
    --network-interfaces '{"AssociatePublicIpAddress":true,"DeviceIndex":0,"Groups":["'"$security_group"'"]}' \
    --metadata-options '{"HttpEndpoint":"enabled","HttpPutResponseHopLimit":2,"HttpTokens":"required"}' \
    --private-dns-name-options '{"HostnameType":"ip-name","EnableResourceNameDnsARecord":true,"EnableResourceNameDnsAAAARecord":false}')
  echo "$run_output" >&2
  instance_id=$(echo "$run_output" | jq -r '.Instances[0].InstanceId')
  aws ec2 wait instance-running --instance-ids "$instance_id"
  host=$(aws ec2 describe-instances --instance-ids "$instance_id" --query 'Reservations[0].Instances[0].PublicDnsName' --output text)
  sed -i "/Host $tag$/,/^\s*\$/{d}" ~/.ssh/ec2hosts 2> /dev/null
  printf "Host $tag\n  HostName $host\n  User %s\n\n" ubuntu >> ~/.ssh/ec2hosts
  command ssh -o 'StrictHostKeyChecking no' "$tag" 'tail -f /var/log/cloud-init-output.log & pid=$!; while [ ! -f /var/lib/cloud/instance/boot-finished ]; do sleep 1; done; kill $pid'
  command ssh "$tag" -O exit || true
  exec command ssh "$tag" -t 'LANG=C.UTF-8 PATH=$HOME/.local/bin:$PATH:$HOME/.vim/bin .vim/bin/tmux new -A -s 0'
}

allow-me() {  # shellcheck disable=2155
  local security_group=$(aws ec2 describe-security-groups --group-names 'ec2-cli-security-group' --query 'SecurityGroups[0].GroupId' --output text 2> /dev/null)
  if [[ -z $security_group ]]; then echo "Security group 'ec2-cli-security-group' not found. Create an instance first." >&2 && return 1; fi
  aws ec2 authorize-security-group-ingress --group-id "$security_group" --ip-permissions "{\"IpProtocol\":\"-1\",\"IpRanges\":[{\"CidrIp\":\"$(curl -s https://checkip.amazonaws.com)/32\",\"Description\":\"me\"}]}"
}

ssh() {
  local tag=${1:-$(aws ec2 describe-instances --filter 'Name=tag-key,Values=Name' 'Name=tag-value,Values=*' "Name=instance-state-name,Values=*" --query "Reservations[*].Instances[*][Tags[?Key=='Name'].Value[] | [0],InstanceId]" --output text | fzf | awk '{print $1}')} host user valid_user
  [[ -z $tag ]] && return 1
  [[ -n $1 ]] && shift
  host=$(aws ec2 describe-instances --filter 'Name=tag-key,Values=Name' 'Name=tag-value,Values=*' 'Name=instance-state-name,Values=running' --query "Reservations[*].Instances[*][NetworkInterfaces[0].Association.PublicDnsName,Tags[?Key=='Name'].Value[] | [0]]" --output text | grep "\s$tag$" | awk '{print $1}')
  if [[ -z $host ]]; then
    change_state start "$tag" && sleep 17 && ssh "$tag" "$@"
    return $?
  fi
  echo "ssh to ec2: $host" >&2
  for user in ubuntu ec2-user admin; do  # default username for ubuntu, AL2, debian
    command ssh -o 'StrictHostKeyChecking no' "$user@$host" exit && valid_user=$user && break
  done
  if [[ -z $valid_user ]]; then echo "Failed to ssh to $host" >&2 && return 1; fi
  sed -i "/Host $tag$/,/^\s*\$/{d}" ~/.ssh/ec2hosts 2> /dev/null
  printf "Host $tag\n  HostName $host\n  User %s\n\n" "$valid_user" >> ~/.ssh/ec2hosts
  exec ssh -o 'StrictHostKeyChecking no' "$valid_user@$host" "$@"
}

main() {
  case $1 in
    start|stop) change_state "$@" ;;
    create|ssh|ls|allow-me) "$@" ;;
    *) echo "Usage: ${0##*/} {start|stop|ls|create|ssh|add-ip} [instance-tag] [options]" >&2; return 1 ;;
  esac
}

main "$@"
